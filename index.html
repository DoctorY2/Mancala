import express from "express";
import bodyParser from "body-parser";

const app = express();
app.use(bodyParser.json());

/**
 * Estado del juego por usuario (fid)
 * En producciÃ³n usa DB
 */
const games = new Map();

function newGame() {
  return {
    board: [4, 4, 4, 4, 4, 4],
    score: 0
  };
}

app.post("/frame", (req, res) => {
  const fid = req.body?.untrustedData?.fid || "anon";
  const button = req.body?.untrustedData?.buttonIndex;

  if (!games.has(fid)) {
    games.set(fid, newGame());
  }

  const game = games.get(fid);

  // Movimiento simple
  if (button) {
    const i = button - 1;
    if (game.board[i] > 0) {
      game.score += game.board[i];
      game.board[i] = 0;
    }
  }

  // SVG del tablero
  const svg = `
<svg width="600" height="400" xmlns="http://www.w3.org/2000/svg">
  <rect width="100%" height="100%" fill="#2c1c12"/>
  <text x="300" y="40" fill="white" font-size="28" text-anchor="middle">
    Gebeta Â· Mancala
  </text>

  ${game.board.map((v, i) => `
    <circle cx="${80 + i * 80}" cy="200" r="30" fill="#6b3f2a"/>
    <text x="${80 + i * 80}" y="210" fill="white" font-size="20" text-anchor="middle">
      ${v}
    </text>
  `).join("")}

  <text x="300" y="350" fill="white" font-size="24" text-anchor="middle">
    Score: ${game.score}
  </text>
</svg>
`;

  const imageBase64 = Buffer.from(svg).toString("base64");

  res.set("Content-Type", "text/html");
  res.send(`
<!DOCTYPE html>
<html>
<head>
  <meta property="fc:frame" content="vNext" />
  <meta property="fc:frame:image" content="data:image/svg+xml;base64,${imageBase64}" />
  <meta property="fc:frame:post_url" content="https://TU_DOMINIO/frame" />

  <meta property="fc:frame:button:1" content="Pozo 1" />
  <meta property="fc:frame:button:2" content="Pozo 2" />
  <meta property="fc:frame:button:3" content="Pozo 3" />
  <meta property="fc:frame:button:4" content="Pozo 4" />
  <meta property="fc:frame:button:5" content="Pozo 5" />
  <meta property="fc:frame:button:6" content="Pozo 6" />
</head>
</html>
`);
});

// ðŸš¨ PUERTO CORRECTO PARA RAILWAY
const PORT = process.env.PORT || 3000;
app.listen(PORT, () => {
  console.log("âœ… Frame activo en puerto", PORT);
});
